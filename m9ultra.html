<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th·∫Øng l√†m vua, thua th·∫ø n√†o ƒë∆∞·ª£c</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* --- M√ÄU C·ªî ƒêI·ªÇN M·ªöI: D√πng Maroon/Red-800 v√† Parchment/Beige --- */
        .classic-text { color: #800000; } /* Maroon/ƒê·ªè ƒê√¥ ƒë·∫≠m */
        .classic-bg { background-color: #800000; } 
        .classic-bg-hover:hover { background-color: #5d0000; } /* Maroon ƒë·∫≠m h∆°n khi hover */
        .classic-light-bg { background-color: #fcf8e8; } /* Parchment/Beige */
        .classic-border { border-color: #a0522d; } /* S·∫Øc n√¢u ƒë·∫•t cho vi·ªÅn */
        /* ----------------------------------------------------------------- */

        body {
            font-family: 'Inter', sans-serif;
            background-image: url('nen.jpg'); 
            background-size: cover; 
            background-position: center center; 
            background-repeat: no-repeat; 
            background-attachment: fixed;
            position: relative; 
        }
        
        /* L·ªõp gi·∫£ t·∫°o hi·ªáu ·ª©ng m·ªù (blur) v√† l·ªõp ph·ªß m√†u tr√™n h√¨nh n·ªÅn */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* C·∫¨P NH·∫¨T: L·ªõp ph·ªß t·ªëi, m·ªù ·∫£o h∆°n */
            background: rgba(0, 0, 0, 0.3); /* Dark, subtle shadow */
            backdrop-filter: blur(5px); 
            z-index: -1; 
        }

        /* --- HI·ªÜU ·ª®NG M·ªöI: Keyframes cho ho·∫°t ·∫£nh --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        @keyframes slideInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Ho·∫°t ·∫£nh cho Vua/Winner */
        @keyframes kingPulse {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(2deg); }
        }
        
        /* --- HI·ªÜU ·ª®NG M·ªöI: CSS cho con v·∫≠t chuy·ªÉn ƒë·ªông --- */
        @keyframes run {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100vw); } 
        }
        
        .animal-container {
            position: relative; 
            overflow: hidden; 
            height: 50px; 
            margin-top: 1rem;
        }

        .animal {
            position: absolute;
            font-size: 2.5rem; 
            white-space: nowrap;
            display: inline-block;
            animation: run linear infinite; 
        }

        /* T√πy ch·ªânh t·ªëc ƒë·ªô cho t·ª´ng con */
        #sheep {
            left: 0;
            top: 5px;
            animation-duration: 20s;
        }
        #chicken {
            left: 0;
            top: 0px;
            animation-duration: 15s;
            animation-delay: 5s;
        }
        #cow {
            left: 0;
            top: 10px;
            animation-duration: 25s;
            animation-delay: 10s;
        }
        /* ------------------------------------------------ */


        /* L·ªõp ti·ªán √≠ch cho ho·∫°t ·∫£nh */
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .animate-slideInDown {
            animation: slideInDown 0.5s ease-out forwards;
        }
        .animate-king-pulse {
             animation: kingPulse 1.5s ease-in-out infinite;
        }

        /* Ho·∫°t ·∫£nh cho ƒë√°p √°n ƒê√∫ng/Sai */
        .correct-answer {
            background-color: #4CAF50 !important; /* Green */
            color: white !important;
            animation: pulse 0.6s ease-in-out;
        }
        .wrong-answer {
            background-color: #F44336 !important; /* Red */
            color: white !important;
            animation: shake 0.6s cubic-bezier(.36,.07,.19,.97);
        }

        /* Hi·ªáu ·ª©ng "Pop" cho c√°c n√∫t */
        .btn-hover-pop {
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-hover-pop:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn-hover-pop:active {
            transform: translateY(0) scale(1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Hover cho B·∫£ng X·∫øp H·∫°ng */
        #scores-list > div {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        #scores-list > div:hover {
            transform: scale(1.03);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
        }
        
        /* C·∫¨P NH·∫¨T: ƒê·ªò TRONG SU·ªêT CHO TH·∫∫ CH·ª®A N·ªòI DUNG */
        #app {
            /* M√†u gi·∫•y da (Parchment/Beige) */
            background-color: #fcf8e8; 
            /* Shadow ƒë·∫≠m h∆°n ƒë·ªÉ n·ªïi b·∫≠t tr√™n n·ªÅn */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center min-h-screen">

    <div id="app" class="w-full max-w-5xl shadow-2xl rounded-xl p-6 sm:p-8 opacity-0 relative">
        
        <h1 id="main-title" class="text-3xl font-extrabold text-center classic-text mb-2">
            Th·∫Øng l√†m vua, thua th·∫ø n√†o ƒë∆∞·ª£c
        </h1>
        <p id="main-subtitle" class="text-center text-gray-700 mb-6">
            M·ªói c√¢u ƒë√∫ng +100 ƒëi·ªÉm, c√¢u sai -100 ƒëi·ªÉm.
        </p>

        <div id="message-box" class="hidden opacity-0 p-4 rounded-lg text-center font-semibold transition duration-300 mb-6"></div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <div id="scoreboard-section" class="lg:col-span-1 pt-6 lg:pt-0 border-t lg:border-t-0 border-gray-400 space-y-4 lg:order-2">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-gray-800">B·∫£ng X·∫øp H·∫°ng & C·∫•p B·∫≠c</h3>
                    <button onclick="resetScores()" class="text-sm text-red-700 hover:text-red-900 transition duration-150 btn-hover-pop px-3 py-1 rounded-md">
                        ƒê·∫∑t L·∫°i ƒêi·ªÉm
                    </button>
                </div>
                <div id="scores-list" class="space-y-2">
                    </div>
            </div>

            <div id="left-column" class="lg:col-span-2 space-y-6 lg:order-1">

                <div id="quiz-section" class="p-4 border border-gray-300 rounded-lg shadow-md opacity-0 classic-light-bg">
                    <h2 id="question-text" class="text-xl font-bold mb-4 text-gray-800"></h2>
                    <div id="choices-container" class="space-y-3">
                        </div>
                </div>
                
                <div id="winner-slide" class="hidden opacity-0 p-8 border-4 border-yellow-600 rounded-xl shadow-2xl bg-yellow-50 text-center space-y-6">
                </div>

                <div id="team-management-section" class="hidden bg-yellow-100 p-5 rounded-lg border border-red-300 opacity-0">
                    <div id="team-selection-ui">
                        <h3 id="team-section-title" class="text-xl font-bold classic-text mb-4 text-center"></h3>
                        <p id="team-section-subtitle" class="text-sm text-gray-700 mb-4 text-center"></p>
                        
                        <div id="team-buttons-container" class="flex flex-wrap justify-center gap-3">
                            </div>
                    </div>
                    <div id="score-confirmation" class="hidden text-center"></div>

                    <div id="animal-container" class="animal-container">
                        <span id="sheep" class="animal">üêë</span>
                        <span id="chicken" class="animal">üêî</span>
                        <span id="cow" class="animal">üêÑ</span>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, onSnapshot, collection, query, setDoc, updateDoc, increment, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- C·∫§U H√åNH FIREBASE V√Ä BI·∫æN TO√ÄN C·ª§C ---
        let app, db, auth;
        let userId = '';
        let isOfflineMode = false; 
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-quiz-app-id';
        
        let firebaseConfig = null;
        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                firebaseConfig = JSON.parse(__firebase_config);
            }
        } catch (e) {
            console.error("L·ªói nghi√™m tr·ªçng: Kh√¥ng th·ªÉ ph√¢n t√≠ch c√∫ ph√°p __firebase_config. Chuy·ªÉn sang ch·∫ø ƒë·ªô Offline.");
            firebaseConfig = null; 
        }
        
        // 7 ƒë·ªôi ch∆°i
        const TEAMS = [
            { id: 'team1', name: 'ƒê·ªôi 1', score: 0 },
            { id: 'team2', name: 'ƒê·ªôi 2', score: 0 },
            { id: 'team3', name: 'ƒê·ªôi 3', score: 0 },
            { id: 'team4', name: 'ƒê·ªôi 4', score: 0 },
            { id: 'team5', name: 'ƒê·ªôi 5', score: 0 },
            { id: 'team6', name: 'ƒê·ªôi 6', score: 0 },
            { id: 'team7', name: 'ƒê·ªôi 7', score: 0 },
        ];
        let mockScores = JSON.parse(JSON.stringify(TEAMS)); 

        const TEAM_COLLECTION_PATH = `artifacts/${appId}/public/data/team_scores`;

        // D·ªØ li·ªáu tr·∫Øc nghi·ªám
        const quizData = [
            { question: "C√°i n√†o sau ƒë√¢y di·ªÖn ƒë·∫°t ƒë√∫ng nh·∫•t ƒë·ªãnh nghƒ©a 'c√°i chung'?", choices: { A: "Nh·ªØng n√©t ch·ªâ c√≥ ·ªü m·ªôt s·ª± v·∫≠t, kh√¥ng l·∫∑p l·∫°i ·ªü s·ª± v·∫≠t kh√°c.", B: "Nh·ªØng m·∫∑t, nh·ªØng thu·ªôc t√≠nh chung t·ªìn t·∫°i trong nhi·ªÅu s·ª± v·∫≠t, hi·ªán t∆∞·ª£ng.", C: "M·ªôt s·ª± v·∫≠t, hi·ªán t∆∞·ª£ng ri√™ng l·∫ª t·ªìn t·∫°i trong kh√¥ng gian v√† th·ªùi gian nh·∫•t ƒë·ªãnh.", D: "M·ªôt quy t·∫Øc √°p d·ª•ng duy nh·∫•t cho m·ªçi tr∆∞·ªùng h·ª£p." }, correctAnswer: 'B' },
            { question: "Khi √°p d·ª•ng m·ªôt quy lu·∫≠t chung v√†o t·ª´ng tr∆∞·ªùng h·ª£p c·ª• th·ªÉ, ƒëi·ªÅu g√¨ l√† c·∫ßn thi·∫øt?", choices: { A: "√Åp d·ª•ng y nguy√™n, kh√¥ng s·ª≠a ƒë·ªïi.", B: "C√° bi·ªát h√≥a theo ƒëi·ªÅu ki·ªán, ho√†n c·∫£nh c·ª• th·ªÉ.", C: "B·ªè qua ho√†n c·∫£nh c·ª• th·ªÉ n·∫øu quy lu·∫≠t ƒë·ªß m·∫°nh.", D: "Ch·ªâ √°p d·ª•ng cho m·ªôt s·ªë ng∆∞·ªùi c√≥ th·∫©m quy·ªÅn." }, correctAnswer: 'B' },
            { question: "M·ªëi quan h·ªá gi·ªØa c√°i chung, c√°i ri√™ng v√† c√°i ƒë∆°n nh·∫•t trong c√πng m·ªôt s·ª± v·∫≠t l√†:", choices: { A: "Ho√†n to√†n t√°ch r·ªùi nhau.", B: "C√°i ri√™ng ch·ª©a c√°i chung v√† c√°i ƒë∆°n nh·∫•t.", C: "C√°i chung t·ªìn t·∫°i ƒë·ªôc l·∫≠p, kh√¥ng c·∫ßn c√°i ri√™ng.", D: "C√°i ƒë∆°n nh·∫•t ch·ª©a c√°i chung." }, correctAnswer: 'B' },
            { question: "ƒê·ªÉ nh·∫≠n th·ª©c ƒë∆∞·ª£c 'c√°i chung', con ng∆∞·ªùi c·∫ßn ph·∫£i:", choices: { A: "Tr·ª±c ti·∫øp quan s√°t √Ω ni·ªám.", B: "Nghi√™n c·ª©u c√°c s·ª± v·∫≠t, hi·ªán t∆∞·ª£ng c·ª• th·ªÉ (c√°i ri√™ng).", C: "T∆∞·ªüng t∆∞·ª£ng ra c√°c quy lu·∫≠t chung.", D: "B·∫Øt ƒë·∫ßu t·ª´ nh·ªØng kh√°i ni·ªám tr·ª´u t∆∞·ª£ng." }, correctAnswer: 'B' },
            { question: "Quy lu·∫≠t 'H·ªçc ƒëi ƒë√¥i v·ªõi h√†nh' l√† v√≠ d·ª• cho lo·∫°i ph·∫°m tr√π n√†o?", choices: { A: "C√°i ri√™ng.", B: "C√°i ƒë∆°n nh·∫•t.", C: "C√°i chung.", D: "Hi·ªán t∆∞·ª£ng c·ª• th·ªÉ." }, correctAnswer: 'C' },
            { question: "Hi·ªán t∆∞·ª£ng n√†o sau ƒë√¢y l√† v√≠ d·ª• c·ªßa c√°i chung chuy·ªÉn th√†nh c√°i ri√™ng?", choices: { A: "M·ªôt phong t·ª•c ƒë·ªãa ph∆∞∆°ng lan r·ªông th√†nh phong t·ª•c to√†n qu·ªëc.", B: "M√¥ h√¨nh d·∫°y h·ªçc truy·ªÅn th·ªëng t·ª´ng ph·ªï bi·∫øn nay ch·ªâ c√≤n ph√π h·ª£p ·ªü v√†i tr∆∞·ªùng.", C: "M·ªôt c√¥ng ngh·ªá m·ªõi ƒë∆∞·ª£c nhi·ªÅu ng∆∞·ªùi √°p d·ª•ng.", D: "M·ªôt s√°ng ki·∫øn c√° nh√¢n lan ra to√†n x√£ h·ªôi." }, correctAnswer: 'B' },
            { question: "Ph√°t bi·ªÉu n√†o sau ƒë√¢y th·ªÉ hi·ªán ƒë√∫ng nh·∫•t vai tr√≤ c·ªßa c√°i ri√™ng?", choices: { A: "L√† h√¨nh th·ª©c t·ªìn t·∫°i c·ª• th·ªÉ c·ªßa c√°i chung.", B: "L√† c√°i ph·ªï bi·∫øn chi ph·ªëi c√°i chung.", C: "L√† c√°i duy nh·∫•t kh√¥ng c√≥ c√°i chung.", D: "L√† s·ª± tr·ª´u t∆∞·ª£ng c·ªßa t∆∞ duy." }, correctAnswer: 'A' },
            { question: "Trong t·ª± nhi√™n, hi·ªán t∆∞·ª£ng 'c√° th·ªÉ ƒë·ªôt bi·∫øn gen' bi·ªÉu hi·ªán ƒëi·ªÅu g√¨ v·ªÅ m·ªëi quan h·ªá gi·ªØa ba ph·∫°m tr√π?", choices: { A: "C√°i chung m·∫•t ƒëi.", B: "C√°i ƒë∆°n nh·∫•t xu·∫•t hi·ªán trong c√°i ri√™ng.", C: "C√°i ri√™ng bi·∫øn m·∫•t.", D: "C√°i chung thay th·∫ø c√°i ri√™ng." }, correctAnswer: 'B' },
            { question: "N·∫øu ch·ªâ ch√∫ tr·ªçng kinh nghi·ªám c√° nh√¢n m√† b·ªè qua quy lu·∫≠t chung, ta d·ªÖ r∆°i v√†o:", choices: { A: "Ch·ªß nghƒ©a gi√°o ƒëi·ªÅu.", B: "Ch·ªß nghƒ©a kinh nghi·ªám.", C: "Ch·ªß nghƒ©a h√¨nh th·ª©c.", D: "T∆∞ duy s√°ng t·∫°o." }, correctAnswer: 'B' },
            { question: "Trong ho·∫°t ƒë·ªông qu·∫£n l√Ω, n·∫øu ng∆∞·ªùi l√£nh ƒë·∫°o ch·ªâ d·ª±a v√†o quy ƒë·ªãnh c·ª©ng nh·∫Øc m√† kh√¥ng x√©t ho√†n c·∫£nh c·ª• th·ªÉ, h·ªç ph·∫°m ph·∫£i sai l·∫ßm g√¨?", choices: { A: "Kinh nghi·ªám ch·ªß nghƒ©a.", B: "Ch·ªß nghƒ©a h√¨nh th·ª©c, gi√°o ƒëi·ªÅu.", C: "Thi·∫øu s√°ng t·∫°o.", D: "Ch·ªß nghƒ©a c√° nh√¢n." }, correctAnswer: 'B' },
            { question: "V√¨ sao n√≥i C√°i Chung s√¢u s·∫Øc h∆°n C√°i Ri√™ng?", choices: { A: "V√¨ c√°i chung ph·∫£n √°nh to√†n b·ªô c√°c thu·ªôc t√≠nh c·ªßa c√°i ri√™ng.", B: "V√¨ c√°i chung ph·∫£n √°nh nh·ªØng thu·ªôc t√≠nh, m·ªëi li√™n h·ªá ·ªïn ƒë·ªãnh, t·∫•t nhi√™n, b·∫£n ch·∫•t l·∫∑p l·∫°i ·ªü nhi·ªÅu c√°i ri√™ng c√πng lo·∫°i.", C: "V√¨ c√°i chung l√† c√°i ph·ªï bi·∫øn.", D: "V√¨ c√°i chung bao qu√°t h·∫øt t·∫•t c·∫£ c√°i ri√™ng." }, correctAnswer: 'B' },
            { question: "L·∫≠p tr∆∞·ªùng tri·∫øt h·ªçc n√†o cho r·∫±ng c√°i chung kh√¥ng t·ªìn t·∫°i th·ª±c trong hi·ªán th·ª±c kh√°ch quan, ch·ªâ l√† t√™n g·ªçi, danh x∆∞ng do con ng∆∞·ªùi ƒë·∫∑t ra cho c√°c ƒë·ªëi t∆∞·ª£ng ƒë∆°n l·∫ª?", choices: { A: "Duy danh", B: "Duy v·∫≠t", C: "Duy t√¢m", D: "Duy th·ª±c" }, correctAnswer: 'A' },
            { question: "Nguy√™n t·∫Øc ph∆∞∆°ng ph√°p lu·∫≠n r√∫t ra t·ª´ c·∫∑p ph·∫°m tr√π C√°i Chung v√† C√°i Ri√™ng l√† ph·∫£i coi tr·ªçng:", choices: { A: "Ch·ªâ coi tr·ªçng c√°i chung (quy lu·∫≠t, nguy√™n t·∫Øc).", B: "Ch·ªâ coi tr·ªçng c√°i ri√™ng (ho√†n c·∫£nh c·ª• th·ªÉ).", C: "C·∫£ c√°i chung (ph·ªï bi·∫øn) v√† c√°i ri√™ng (c·ª• th·ªÉ), trong ƒë√≥ ph·∫£i linh ho·∫°t c√° bi·ªát h√≥a c√°i chung khi √°p d·ª•ng v√†o c√°i ri√™ng.", D: "B·ªè qua c√°i ƒë∆°n nh·∫•t." }, correctAnswer: 'C' },
            { question: "Vi·ªác t·ª•c l·ªá 'nhu·ªôm rƒÉng ƒëen' t·ª´ng l√† 'c√°i chung' (ph·ªï bi·∫øn) ·ªü Vi·ªát Nam nay tr·ªü th√†nh 'c√°i ƒë∆°n nh·∫•t' (r·∫•t hi·∫øm g·∫∑p) cho th·∫•y ƒëi·ªÅu g√¨?", choices: { A: "C√°i chung l√† vƒ©nh vi·ªÖn, b·∫•t bi·∫øn, kh√¥ng bao gi·ªù m·∫•t ƒëi.", B: "C√°i chung ch·ªâ l√† s·∫£n ph·∫©m c·ªßa t∆∞ duy, kh√¥ng c√≥ th·∫≠t trong l·ªãch s·ª≠.", C: "C√°i chung mang t√≠nh l·ªãch s·ª≠; c√°i chung ·ªü giai ƒëo·∫°n n√†y c√≥ th·ªÉ th√†nh c√°i ƒë∆°n nh·∫•t ·ªü giai ƒëo·∫°n sau do kh√¥ng c√≤n ph√π h·ª£p.", D: "C√°i ri√™ng (ng∆∞·ªùi nhu·ªôm rƒÉng) quy·∫øt ƒë·ªãnh ho√†n to√†n c√°i chung (t·ª•c l·ªá)." }, correctAnswer: 'C' },
            { question: "ƒêi·ªÅn t·ª´ th√≠ch h·ª£p v√†o √¥ tr·ªëng: 'Trong nh·∫≠n th·ª©c v√† th·ª±c ti·ªÖn, m·ªói s·ª± v·∫≠t v·ª´a c√≥ nh·ªØng ƒë·∫∑c ƒëi·ªÉm chung, v·ª´a c√≥ nh·ªØng n√©t ri√™ng v√† ƒë√¥i khi mang nh·ªØng n√©t ƒë·ªôc nh·∫•t. (...) ph·∫£n √°nh b·∫£n ch·∫•t, quy lu·∫≠t, l·∫∑p l·∫°i trong nhi·ªÅu c√°i ri√™ng, nh∆∞ng ch·ªâ t·ªìn t·∫°i th√¥ng qua c√°c (...) c·ª• th·ªÉ. Ng∆∞·ª£c l·∫°i, m·ªói (...) ƒë·ªÅu ch·ª©a c√°i chung, nh∆∞ng c√≥ ƒëi·ªÅu ki·ªán ri√™ng, n√™n khi v·∫≠n d·ª•ng c·∫ßn (...) ƒë·ªÉ ph√π h·ª£p. (...) c√≥ th·ªÉ tr·ªü th√†nh c√°i chung n·∫øu ƒë∆∞·ª£c l·∫∑p l·∫°i v√† c√¥ng nh·∫≠n r·ªông r√£i, c√≤n c√°i chung c≈©ng c√≥ th·ªÉ tr·ªü th√†nh c√°i ri√™ng khi ƒëi·ªÅu ki·ªán thay ƒë·ªïi. Hi·ªÉu m·ªëi quan h·ªá bi·ªán ch·ª©ng n√†y gi√∫p v·ª´a khai th√°c quy lu·∫≠t chung, v·ª´a t√¥n tr·ªçng n√©t ƒë·ªôc ƒë√°o c√° bi·ªát, tr√°nh kinh nghi·ªám ch·ªß nghƒ©a hay gi√°o ƒëi·ªÅu.' (L·ª±a ch·ªçn l√† chu·ªói 5 t·ª´ ƒëi·ªÅn v√†o 5 ch·ªó tr·ªëng theo th·ª© t·ª±)", choices: { A: "C√°i chung, c√°i ri√™ng, c√°i ri√™ng, c√° bi·ªát h√≥a, c√°i ƒë∆°n nh·∫•t.", B: "C√°i ri√™ng, c√°i chung, c√°i ri√™ng, c√° bi·ªát h√≥a, c√°i ƒë∆°n nh·∫•t.", C: "C√°i t·ªïng th·ªÉ, c√°i chung, c√°i ri√™ng, c√°i ƒë∆°n nh·∫•t, c√° bi·ªát h√≥a.", D: "C√°i ri√™ng, c√° bi·ªát h√≥a, c√°i chung, c√°i ƒë∆°n nh·∫•t, c√° bi·ªát h√≥a." }, correctAnswer: 'A' }
        ];

        const TOTAL_QUESTIONS = quizData.length;
        const SCORE_CHANGE = 100; 

        let gameState = {
            quizActive: true,
            currentQuestionIndex: 0,
            currentTeamId: null,
            currentTeamName: null,
            scoresCache: [] // Th√™m cache ƒëi·ªÉm s·ªë
        };

        const PROGRESSION_MAX = 1500; 
        const TIER_THRESHOLDS = [
            { name: "V√¥ gia c∆∞", minScore: -Infinity, maxScore: 299, color: 'bg-gray-500', icon: 'üè†' }, 
            { name: "N√¥ng d√¢n", minScore: 300, maxScore: 599, color: 'bg-yellow-800', icon: 'üåæ' },
            { name: "ƒê·ªãa ch·ªß", minScore: 600, maxScore: 899, color: 'bg-green-700', icon: 'üí∞' },
            /* C·∫¨P NH·∫¨T: M√†u quan (Quan) sang Maroon/ƒê·ªè ƒê√¥ */
            { name: "Quan", minScore: 900, maxScore: 1199, color: 'bg-red-800', icon: 'üìú' },
            { name: "Vua", minScore: 1200, maxScore: Infinity, color: 'bg-red-900', icon: 'üëë' } 
        ];
        
        function getTierInfo(score) {
            let selectedTier = TIER_THRESHOLDS[0];
            let progress = 0;
            
            for (const tier of TIER_THRESHOLDS) {
                if (score >= tier.minScore && score <= tier.maxScore) {
                    selectedTier = tier;
                    break;
                }
            }
            const normalizedScore = Math.max(0, score);
            progress = Math.min(100, (normalizedScore / PROGRESSION_MAX) * 100);
            
            return { ...selectedTier, progress };
        }

        // --- H√†m tr·ª£ gi√∫p ho·∫°t ·∫£nh ---
        function animateElement(elementId, animationClass) {
            const el = document.getElementById(elementId);
            if (el) {
                el.classList.remove(animationClass, 'opacity-0');
                // Bu·ªôc tr√¨nh duy·ªát "reflow" ƒë·ªÉ ch·∫°y l·∫°i ho·∫°t ·∫£nh
                void el.offsetWidth;
                el.classList.add(animationClass);
            }
        }

        async function initializeFirebase() {
            if (!firebaseConfig) {
                isOfflineMode = true;
                console.warn("Ch·∫ø ƒë·ªô OFFLINE ƒë∆∞·ª£c k√≠ch ho·∫°t: Firebase b·ªã v√¥ hi·ªáu h√≥a.");
                renderScores(mockScores);
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        initializeTeams(); 
                        fetchScores();
                    } else {
                        userId = crypto.randomUUID(); 
                        initializeTeams();
                        fetchScores();
                    }
                });

            } catch (error) {
                console.error("L·ªói kh·ªüi t·∫°o ho·∫∑c x√°c th·ª±c Firebase:", error);
                alertMessage(`L·ªói h·ªá th·ªëng: Kh√¥ng th·ªÉ k·∫øt n·ªëi (Firebase): ${error.message}`, 'bg-red-100', 'text-red-700');
                isOfflineMode = true;
                renderScores(mockScores);
            }
        }
        
        async function initializeTeams() {
            if (isOfflineMode || !db) return;
            for (const team of TEAMS) {
                const teamDocRef = doc(db, TEAM_COLLECTION_PATH, team.id);
                try {
                    const docSnap = await getDoc(teamDocRef);
                    if (!docSnap.exists()) {
                        await setDoc(teamDocRef, { name: team.name, score: 0 });
                    }
                } catch (e) {
                    console.error(`L·ªói kh·ªüi t·∫°o ƒë·ªôi ${team.name}:`, e);
                }
            }
        }

        // --- X·ª¨ L√ù TR·∫ÆC NGHI·ªÜM ---

        function renderQuiz() {
            const teamMgmtSection = document.getElementById('team-management-section');
            const quizSection = document.getElementById('quiz-section');
            const winnerSlide = document.getElementById('winner-slide'); 
            const confirmationDiv = document.getElementById('score-confirmation');
            const teamSelectionUI = document.getElementById('team-selection-ui');
            
            quizSection.classList.add('hidden', 'opacity-0');
            teamMgmtSection.classList.add('hidden', 'opacity-0');
            winnerSlide.classList.add('hidden', 'opacity-0'); 
            confirmationDiv.classList.add('hidden');
            teamSelectionUI.classList.remove('hidden'); 

            if (gameState.currentQuestionIndex >= TOTAL_QUESTIONS) {
                // ƒê√£ h·∫øt c√¢u h·ªèi, hi·ªÉn th·ªã slide vinh danh
                renderFinalWinnerSlide();
                return;
            }
            
            if (gameState.currentTeamId === null) {
                teamMgmtSection.classList.remove('hidden'); 
                quizSection.classList.add('hidden'); 
                renderTeamSelectionButtons();
                animateElement('team-management-section', 'animate-fadeIn'); 
            
            } else {
                teamMgmtSection.classList.add('hidden'); 
                quizSection.classList.remove('hidden'); 

                const currentQuestion = quizData[gameState.currentQuestionIndex];
                const qNum = gameState.currentQuestionIndex + 1;

                document.getElementById('question-text').className = "text-xl font-bold mb-4 text-gray-800";
                // C·∫¨P NH·∫¨T: D√πng m√†u c·ªï ƒëi·ªÉn cho t√™n ƒë·ªôi
                document.getElementById('question-text').innerHTML = `
                    <span class="block text-sm font-medium classic-text">${gameState.currentTeamName} ƒëang tr·∫£ l·ªùi:</span>
                    C√¢u h·ªèi ${qNum}/${TOTAL_QUESTIONS}: ${currentQuestion.question}
                `;
                
                const choicesContainer = document.getElementById('choices-container');
                choicesContainer.innerHTML = '';
                
                const choiceKeys = Object.keys(currentQuestion.choices);

                choiceKeys.forEach(key => {
                    const button = document.createElement('button');
                    button.setAttribute('data-choice', key);
                    // C·∫¨P NH·∫¨T: B·ªè hover indigo-50
                    button.className = "choice-btn w-full p-4 text-left border border-gray-200 rounded-lg hover:bg-yellow-50 transition duration-150 font-medium text-gray-800 btn-hover-pop";
                    button.innerHTML = `<span class="font-bold mr-2">${key}.</span> ${currentQuestion.choices[key]}`;
                    button.onclick = () => handleAnswer(key, currentQuestion.correctAnswer);
                    choicesContainer.appendChild(button);
                });
                
                gameState.quizActive = true;
                animateElement('quiz-section', 'animate-fadeIn'); 
            }
        }

        // --- H√ÄM VINH DANH NG∆Ø·ªúI CHI·∫æN TH·∫ÆNG ---
        function renderFinalWinnerSlide() {
            const quizSection = document.getElementById('quiz-section');
            const teamMgmtSection = document.getElementById('team-management-section');
            const winnerSlide = document.getElementById('winner-slide');
            const currentScores = isOfflineMode ? mockScores : gameState.scoresCache; 
            currentScores.sort((a, b) => b.score - a.score);
            
            quizSection.classList.add('hidden');
            teamMgmtSection.classList.add('hidden');
            winnerSlide.classList.remove('hidden');
            
            // 1. T√¨m ƒë·ªôi chi·∫øn th·∫Øng (ng∆∞·ªùi ƒë·ª©ng ƒë·∫ßu trong scoresCache ƒë√£ ƒë∆∞·ª£c s·∫Øp x·∫øp)
            const winner = currentScores.length > 0 ? currentScores[0] : null;
            
            if (winner) {
                // 2. L·∫•y th√¥ng tin c·∫•p b·∫≠c c·ªßa ƒë·ªôi chi·∫øn th·∫Øng
                const tierInfo = getTierInfo(winner.score);
                const isKing = tierInfo.name === 'Vua';
                
                let titleContent, subtitleContent, winnerClass, winnerIcon, titleColorClass;

                if (isKing) {
                    // K·ªãch b·∫£n 1: C√ì VUA (ƒêi·ªÉm >= 1200)
                    titleContent = `üëë CH√öC M·ª™NG V·ªä VUA M·ªöI üëë`;
                    subtitleContent = `ƒê·ªôi Chi·∫øn Th·∫Øng Tuy·ªát ƒê·ªëi L√†:`;
                    winnerClass = 'bg-white border-4 border-yellow-600 shadow-xl';
                    winnerIcon = 'üèÜ';
                    titleColorClass = 'text-red-800 animate-king-pulse'; /* C·∫¨P NH·∫¨T: M√†u ƒë·ªè ƒë·∫≠m */
                } else if (winner.score >= TIER_THRESHOLDS[0].minScore) { 
                    // K·ªãch b·∫£n 2: C√ì NG∆Ø·ªúI D·∫™N ƒê·∫¶U, NH∆ØNG KH√îNG PH·∫¢I VUA (ƒêi·ªÉm d∆∞∆°ng ho·∫∑c ƒë·∫°t c·∫•p b·∫≠c cao h∆°n V√¥ gia c∆∞)
                    titleContent = `‚ú® VINH DANH NG∆Ø·ªúI D·∫™N ƒê·∫¶U ‚ú®`;
                    subtitleContent = `ƒê·ªôi Xu·∫•t S·∫Øc Nh·∫•t Gi·∫£i ƒê·∫•u L√†:`;
                    winnerClass = 'bg-white border-4 border-red-500 shadow-xl'; /* C·∫¨P NH·∫¨T: Vi·ªÅn ƒë·ªè */
                    winnerIcon = '‚≠ê';
                    titleColorClass = 'classic-text'; /* C·∫¨P NH·∫¨T: M√†u c·ªï ƒëi·ªÉn */
                } else {
                    // K·ªãch b·∫£n 3: KH√îNG ƒê·ªòI N√ÄO ƒê·∫†T ƒêI·ªÇM D∆Ø∆†NG CAO (ƒêi·ªÉm th·∫•p nh·∫•t, d∆∞·ªõi 300)
                    titleContent = `‚ö†Ô∏è K·∫æT TH√öC TH·ª¨ TH√ÅCH ‚ö†Ô∏è`;
                    subtitleContent = `Kh√¥ng ƒë·ªôi n√†o v∆∞·ª£t qua ƒë∆∞·ª£c ng∆∞·ª°ng th·ª≠ th√°ch. ƒê·ªôi √≠t sai s√≥t nh·∫•t (ƒêi·ªÉm cao nh·∫•t) l√†:`;
                    winnerClass = 'bg-white border-4 border-gray-400 shadow-xl';
                    winnerIcon = 'üòî';
                    titleColorClass = 'text-gray-600';
                }
                
                // Chuy·ªÉn class BG th√†nh class Text cho hi·ªÉn th·ªã c·∫•p b·∫≠c
                const tierTextColorClass = tierInfo.color.replace('bg-', 'text-');

                // 3. X√¢y d·ª±ng n·ªôi dung slide vinh danh
                winnerSlide.innerHTML = `
                    <h2 class="text-4xl sm:text-6xl font-extrabold ${titleColorClass}">
                        ${titleContent}
                    </h2>
                    <p class="text-xl sm:text-3xl font-bold text-gray-700">${subtitleContent}</p>
                    
                    <div class="inline-block px-8 sm:px-12 py-4 sm:py-6 ${winnerClass} rounded-full">
                        <p class="text-3xl sm:text-5xl font-extrabold classic-text">${winnerIcon} ${winner.name}</p>
                    </div>

                    <p class="text-lg sm:text-2xl font-semibold text-gray-700">V·ªõi T·ªïng ƒêi·ªÉm: 
                        <span class="font-extrabold ${winner.score < 0 ? 'text-red-700' : 'text-green-700'}">${winner.score}</span> ƒëi·ªÉm
                    </p>

                    <div class="text-md sm:text-lg font-medium text-gray-600">
                        <p>ƒê√£ ƒë·∫°t C·∫•p B·∫≠c: 
                            <span class="font-bold ${tierTextColorClass}">${tierInfo.icon} ${tierInfo.name}</span>
                        </p>
                    </div>
                    
                    <button onclick="restartQuiz()" class="mt-4 w-full max-w-xs mx-auto px-4 py-3 classic-bg text-white rounded-lg classic-bg-hover transition duration-150 btn-hover-pop text-lg font-semibold">
                        B·∫Øt ƒê·∫ßu V√≤ng Ch∆°i M·ªõi
                    </button>
                `;
            } else {
                 // K·ªãch b·∫£n 4: KH√îNG C√ì D·ªÆ LI·ªÜU ƒê·ªòI N√ÄO (L·ªói ho·∫∑c ch∆∞a ch∆°i)
                 winnerSlide.innerHTML = `
                    <h2 class="text-3xl font-extrabold text-red-600">CH∆ØA C√ì ƒê·ªòI N√ÄO GHI ƒêI·ªÇM!</h2>
                    <p class="text-xl text-gray-700">H√£y b·∫Øt ƒë·∫ßu tr·∫£ l·ªùi c√¢u h·ªèi ƒë·ªÉ t√¨m ra ng∆∞·ªùi chi·∫øn th·∫Øng.</p>
                    <button onclick="restartQuiz()" class="mt-4 w-full max-w-xs mx-auto px-4 py-3 classic-bg text-white rounded-lg classic-bg-hover transition duration-150 btn-hover-pop text-lg font-semibold">
                        B·∫Øt ƒê·∫ßu Ch∆°i
                    </button>
                `;
            }

            animateElement('winner-slide', 'animate-fadeIn'); 
            document.getElementById('main-title').classList.add('hidden');
            document.getElementById('main-subtitle').classList.add('hidden');
        }

        
        function renderTeamSelectionButtons() {
            const container = document.getElementById('team-buttons-container');
            const title = document.getElementById('team-section-title');
            const subtitle = document.getElementById('team-section-subtitle');

            const qNum = gameState.currentQuestionIndex + 1;
            const totalQ = TOTAL_QUESTIONS;

            title.className = 'text-xl font-bold classic-text mb-4 text-center';
            title.innerText = `B·∫Øt ƒë·∫ßu L∆∞·ª£t Ch∆°i: C√¢u h·ªèi ${qNum}/${totalQ}`;
            subtitle.innerText = 'Vui l√≤ng ch·ªçn ƒë·ªôi s·∫Ω tr·∫£ l·ªùi c√¢u h·ªèi n√†y.';
            
            container.innerHTML = '';
            // C·∫¨P NH·∫¨T: D√πng Flexbox ƒë·ªÉ c√°c n√∫t n·∫±m ngang
            container.className = "flex flex-wrap justify-center gap-3"; 

            TEAMS.forEach(team => {
                const button = document.createElement('button');
                button.setAttribute('data-team-id', team.id);
                // C·∫¨P NH·∫¨T: T·∫•t c·∫£ c√°c ƒë·ªôi d√πng m√†u Maroon m·ªõi
                button.className = "team-score-btn w-1/5 min-w-[80px] px-2 py-2 text-sm classic-bg text-white font-semibold rounded-lg classic-bg-hover transition duration-150 shadow-md btn-hover-pop";
                button.innerText = team.name;
                button.onclick = () => selectTeam(team.id, team.name);
                container.appendChild(button);
            });
        }
        
        window.selectTeam = (teamId, teamName) => {
            gameState.currentTeamId = teamId;
            gameState.currentTeamName = teamName;
            renderQuiz(); 
        }
        
        window.handleAnswer = (selectedAnswer, correctAnswer) => {
            if (!gameState.quizActive) return;

            gameState.quizActive = false;
            const isCorrect = selectedAnswer === correctAnswer;
            
            const buttons = document.querySelectorAll('.choice-btn');
            buttons.forEach(btn => {
                btn.disabled = true;
                const choiceKey = btn.getAttribute('data-choice');
                btn.classList.remove('hover:bg-yellow-50', 'btn-hover-pop'); // C·∫¨P NH·∫¨T: B·ªè hover c≈©
                btn.classList.add('text-gray-500'); // M·ªù c√°c n√∫t ch∆∞a ch·ªçn

                if (choiceKey === selectedAnswer) {
                    btn.classList.remove('text-gray-500');
                    btn.classList.add(isCorrect ? 'correct-answer' : 'wrong-answer');
                } else if (choiceKey === correctAnswer) {
                    if (!isCorrect) {
                        btn.classList.add('correct-answer');
                    }
                }
            });

            const scoreChange = isCorrect ? SCORE_CHANGE : -SCORE_CHANGE;
            
            // Th√™m ƒë·ªô tr·ªÖ nh·ªè ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y hi·ªáu ·ª©ng
            setTimeout(() => {
                if (isCorrect) {
                    alertMessage(`Ch√≠nh x√°c! ${gameState.currentTeamName} ƒë∆∞·ª£c c·ªông ${SCORE_CHANGE} ƒëi·ªÉm.`, 'bg-green-100', 'text-green-700');
                } else {
                    alertMessage(`Sai r·ªìi. ƒê√°p √°n ƒë√∫ng l√† ${correctAnswer}. ${gameState.currentTeamName} b·ªã tr·ª´ ${SCORE_CHANGE} ƒëi·ªÉm.`, 'bg-red-100', 'text-red-700');
                }
                recordTeamScore(gameState.currentTeamId, gameState.currentTeamName, scoreChange);
            }, 700); // 700ms ƒë·ªÉ xem ho·∫°t ·∫£nh
        }
        
        async function recordTeamScore(teamId, teamName, scoreChange) {
            let success = false;
            let actionText = scoreChange > 0 ? 'c·ªông' : 'tr·ª´';
            let scoreDisplay = Math.abs(scoreChange);
            
            if (isOfflineMode) {
                const teamIndex = mockScores.findIndex(t => t.id === teamId);
                if (teamIndex !== -1) {
                    mockScores[teamIndex].score += scoreChange;
                    renderScores(mockScores);
                    success = true;
                }
            } 
            else if (db) {
                try {
                    const teamDocRef = doc(db, TEAM_COLLECTION_PATH, teamId);
                    await updateDoc(teamDocRef, {
                        score: increment(scoreChange), 
                        lastUpdated: new Date().toISOString(),
                    });
                    success = true;
                } catch (error) {
                    console.error("L·ªói khi c·ªông ƒëi·ªÉm s·ªë (Online):", error);
                    alertMessage(`L·ªói khi c·ªông ƒëi·ªÉm: ${error.message}`, 'bg-red-100', 'text-red-700');
                    return;
                }
            } else {
                alertMessage("L·ªói h·ªá th·ªëng: Kh√¥ng th·ªÉ ghi ƒëi·ªÉm v√¨ kh√¥ng c√≥ k·∫øt n·ªëi c∆° s·ªü d·ªØ li·ªáu.", 'bg-red-100', 'text-red-700');
                return;
            }

            if (success) {
                const isFinalQuestion = (gameState.currentQuestionIndex + 1) >= TOTAL_QUESTIONS;
                const teamMgmtSection = document.getElementById('team-management-section');
                const confirmationDiv = document.getElementById('score-confirmation');
                const teamSelectionUI = document.getElementById('team-selection-ui');

                teamMgmtSection.classList.remove('hidden', 'opacity-0'); 
                teamSelectionUI.classList.add('hidden'); 
                confirmationDiv.classList.remove('hidden'); 
                
                confirmationDiv.innerHTML = `
                    <p class="text-xl font-bold ${scoreChange > 0 ? 'text-green-700' : 'text-red-700'} text-center mb-4">
                        ‚úÖ ${teamName} ƒë√£ b·ªã ${actionText} ${scoreDisplay} ƒëi·ªÉm!
                        </p>
                    <button onclick="goToNextQuestion()" class="mt-2 w-full px-4 py-2 classic-bg text-white rounded-lg classic-bg-hover transition duration-150 btn-hover-pop">
                        ${isFinalQuestion ? 'Xem K·∫øt Qu·∫£ Cu·ªëi C√πng' : 'Ch∆°i C√¢u Ti·∫øp Theo'}
                    </button>
                `;
                // Ch·∫°y hi·ªáu ·ª©ng cho ph·∫ßn x√°c nh·∫≠n
                animateElement('team-management-section', 'animate-fadeIn');
            }
        };
        
        window.resetScores = async () => {
            const isConfirmed = prompt("C·∫¢NH B√ÅO: Thao t√°c n√†y s·∫Ω ƒë·∫∑t l·∫°i ƒëi·ªÉm c·ªßa T·∫§T C·∫¢ c√°c ƒë·ªôi v·ªÅ 0. G√µ 'RESET' ƒë·ªÉ x√°c nh·∫≠n.");
            if (isConfirmed !== 'RESET') {
                alertMessage("Thao t√°c ƒë·∫∑t l·∫°i ƒë√£ b·ªã h·ªßy.", 'bg-yellow-100', 'text-yellow-700');
                return;
            }

            if (isOfflineMode) {
                mockScores.forEach(team => team.score = 0);
                renderScores(mockScores);
                alertMessage("ƒê√£ ƒë·∫∑t l·∫°i ƒëi·ªÉm s·ªë (Ch·∫ø ƒë·ªô Offline)!", 'bg-green-100', 'text-green-700');
            }
            else if (db) {
                try {
                    const batch = writeBatch(db);
                    const scoresCollectionRef = collection(db, TEAM_COLLECTION_PATH);
                    
                    const snapshot = await getDocs(scoresCollectionRef);
                    snapshot.forEach(docSnapshot => {
                        batch.update(doc(db, TEAM_COLLECTION_PATH, docSnapshot.id), { score: 0 });
                    });

                    await batch.commit();
                    alertMessage("ƒê√£ ƒë·∫∑t l·∫°i ƒëi·ªÉm s·ªë c·ªßa t·∫•t c·∫£ c√°c ƒë·ªôi v·ªÅ 0!", 'bg-green-100', 'text-green-700');
                } catch (error) {
                    console.error("L·ªói khi ƒë·∫∑t l·∫°i ƒëi·ªÉm s·ªë:", error);
                    alertMessage(`L·ªói khi ƒë·∫∑t l·∫°i ƒëi·ªÉm: ${error.message}`, 'bg-red-100', 'text-red-700');
                    return;
                }
            } else {
                alertMessage("Kh√¥ng th·ªÉ ƒë·∫∑t l·∫°i ƒëi·ªÉm s·ªë v√¨ kh√¥ng c√≥ k·∫øt n·ªëi c∆° s·ªü d·ªØ li·ªáu.", 'bg-red-100', 'text-red-700');
                return;
            }
            
            gameState.currentQuestionIndex = 0;
            gameState.currentTeamId = null; 
            gameState.currentTeamName = null;

            document.getElementById('main-title').classList.remove('hidden');
            document.getElementById('main-subtitle').classList.remove('hidden');
            renderQuiz(); 
        };

        function fetchScores() {
            if (isOfflineMode || !db) return;

            const scoresCollectionRef = collection(db, TEAM_COLLECTION_PATH);
            const q = query(scoresCollectionRef);

            onSnapshot(q, (snapshot) => {
                let scores = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    scores.push({ id: doc.id, ...data });
                });
                scores.sort((a, b) => b.score - a.score);
                gameState.scoresCache = scores; // C·∫≠p nh·∫≠t cache ƒëi·ªÉm s·ªë
                renderScores(scores);
            }, (error) => {
                console.error("L·ªói khi l·∫Øng nghe ƒëi·ªÉm s·ªë:", error);
                document.getElementById('scores-list').innerHTML = `<p class="text-red-500">Kh√¥ng th·ªÉ t·∫£i b·∫£ng x·∫øp h·∫°ng.</p>`;
            });
        }

        function renderScores(scores) {
            const scoresList = document.getElementById('scores-list');
            scoresList.innerHTML = ''; 

            if (scores.length === 0) {
                scoresList.innerHTML = `<p class="text-gray-500 text-center py-4">Ch∆∞a c√≥ ƒëi·ªÉm s·ªë ƒë·ªôi n√†o ƒë∆∞·ª£c l∆∞u.</p>`;
                return;
            }

            scores.forEach((score, index) => {
                const scoreItem = document.createElement('div');
                const tierInfo = getTierInfo(score.score); 
                const rank = index + 1;
                let bgColor = 'bg-white';
                
                if (rank === 1) bgColor = 'bg-yellow-100 border-yellow-500';
                else if (rank === 2) bgColor = 'bg-gray-100 border-gray-400';
                else if (rank === 3) bgColor = 'bg-orange-100 border-orange-400';
                else bgColor = 'bg-white border-gray-200';

                // Thay th·∫ø tierInfo.color b·∫±ng tierTextColorClass (text-...)
                const tierTextColorClass = tierInfo.color.replace('bg-', 'text-');

                // C·∫¨P NH·∫¨T: N·ªÅn b·∫£ng ƒëi·ªÉm d√πng m√†u gi·∫•y da
                scoreItem.className = `p-4 rounded-lg border shadow-lg classic-light-bg space-y-2`;
                scoreItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-4">
                            <span class="font-extrabold text-xl classic-text w-6 text-center">${rank}.</span>
                            <span class="font-bold text-lg text-gray-800">${score.name}</span>
                        </div>
                        <div class="text-right flex items-center space-x-2">
                            <p class="text-sm font-semibold text-gray-700 flex items-center ${tierTextColorClass}">
                                ${tierInfo.icon} <span class="ml-1">${tierInfo.name}</span>
                            </p>
                            <span class="font-bold text-2xl ${score.score < 0 ? 'text-red-700' : 'text-green-700'}">${score.score}</span>
                        </div>
                    </div>
                    
                    <div class="w-full bg-gray-300 rounded-full h-2.5">
                        <div class="h-2.5 rounded-full transition-all duration-500 ${tierInfo.color}" 
                             style="width: ${tierInfo.progress}%;">
                        </div>
                    </div>
                    <p class="text-xs text-gray-600 text-right">
                        Ti·∫øn ƒë·ªô ƒë·∫øn c·∫•p b·∫≠c Vua (1500 ƒëi·ªÉm): ${Math.round(tierInfo.progress)}%
                    </p>
                `;
                scoresList.appendChild(scoreItem);
            });
        }
        
        // H√†m th√¥ng b√°o d√πng ho·∫°t ·∫£nh
        function alertMessage(text, bgColorClass, textColorClass) {
            const messageBox = document.getElementById('message-box');
            // ƒê·∫∑t l·∫°i ho·∫°t ·∫£nh
            messageBox.classList.remove('animate-slideInDown');
            void messageBox.offsetWidth; // Bu·ªôc reflow

            messageBox.classList.remove('hidden', 'opacity-0', 'bg-red-100', 'bg-green-100', 'bg-yellow-100', 'text-red-700', 'text-green-700', 'text-yellow-700');
            messageBox.classList.add(bgColorClass, textColorClass, 'animate-slideInDown');
            messageBox.innerText = text;
            messageBox.classList.remove('hidden');
            
            // X√≥a b·ªô ƒë·∫øm th·ªùi gian c≈© n·∫øu c√≥
            if (messageBox.timer) {
                clearTimeout(messageBox.timer);
            }

            messageBox.timer = setTimeout(() => {
                messageBox.classList.add('hidden'); 
                messageBox.classList.remove('animate-slideInDown'); // D·ªçn d·∫πp
                messageBox.classList.add('opacity-0');
            }, 5000);
        }

        // --- KH·ªûI CH·∫†Y ·ª®NG D·ª§NG ---
        window.onload = function () {
            console.log("·ª®ng d·ª•ng Quiz ƒê·ªôi Ch∆°i ƒëang kh·ªüi t·∫°o...");
            
            // Ch·∫°y hi·ªáu ·ª©ng fade-in cho th·∫ª ch√≠nh
            const appCard = document.getElementById('app');
            appCard.classList.add('animate-fadeIn');
            appCard.classList.remove('opacity-0');

            initializeFirebase(); 
            renderQuiz(); 
        };

        // G·∫Øn c√°c h√†m v√†o window ƒë·ªÉ c√≥ th·ªÉ g·ªçi t·ª´ HTML
        window.resetScores = resetScores; 
        window.renderQuiz = renderQuiz;
        window.handleAnswer = handleAnswer;
        window.selectTeam = selectTeam;

        window.restartQuiz = () => {
            gameState.currentQuestionIndex = 0;
            gameState.currentTeamId = null; 
            gameState.currentTeamName = null;
            
            document.getElementById('main-title').classList.remove('hidden');
            document.getElementById('main-subtitle').classList.remove('hidden');
            renderQuiz();
        };

        window.goToNextQuestion = () => {
            gameState.currentQuestionIndex++;
            gameState.currentTeamId = null; 
            gameState.currentTeamName = null;
            renderQuiz();
        };

    </script>
</body>
</html>